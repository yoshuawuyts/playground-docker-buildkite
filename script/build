#!/bin/bash

version="$(jq '.version' < package.json | sed 's/"//g')"
commit="$(git log --oneline | head -1 | awk '{ print $1 }')"
name="playground-docker-buildkite"
date="$(date --iso-8601=seconds)"
username="yoshuawuyts"

run_build () {
  sudo docker build -f "./docker/base/Dockerfile" \
    -t "$name:base" \
    --label "date=$date" \
    --label "commit=$commit" \
    --label "dockerfile=Dockerfile" \
    --label "repository=https://github.com/$username/$name" \
    .
}

run_optimize () {
  sudo docker build -f "./docker/optimize/Dockerfile" \
    -t "$name:latest" \
    -t "$name:optimize" \
    -t "$name:$version" \
    --label "date=$date" \
    --label "commit=$commit" \
    --label "dockerfile=Dockerfile" \
    --label "repository=https://github.com/$username/$name" \
    .
}

usage () {
  printf 'Usage: script/build [options]'
}

# set CLI flags
args="$(getopt ho "$*")"
[ $? -ne 0 ] && { usage; exit 2; }
eval set -- "$args"

# parse CLI flags
while true; do
  case "$1" in
    -h ) usage ;;
    -o ) shift; run_optimize; break ;;
    * ) shift; run_build; break ;;
  esac
done
